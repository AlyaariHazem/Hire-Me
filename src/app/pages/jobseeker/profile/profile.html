<form [formGroup]="basicForm" class="form-section">
  <h3 class="section-title"><span><i class="pi pi-user"></i></span>ุงููุนูููุงุช ุงูุดุฎุตูุฉ</h3>
  <!-- ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ -->
  <div class="resume-wrap">
    @if(resumeUrl){

    <div class="resume-bar">
      <div class="resume-meta">
        <span class="resume-icon">๐</span>
        <div>
          <div class="resume-name">{{ resumeDisplayName }}</div>
          <div class="resume-type">{{ isPdf ? 'PDF' : 'Document' }}</div>
        </div>
      </div>

      <div class="resume-actions">
        <p-button label="ุชุบููุฑ ุงูููู" styleClass="p-button-secondary" [style]="{ margin: 0 }"
          (onClick)="resumeFileInput.click()"></p-button>
        <input #resumeFileInput type="file" class="d-none" accept=".pdf,.doc,.docx" (change)="onResumeChange($event)"
          title="ุชุบููุฑ ููู ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ" aria-label="ุชุบููุฑ ููู ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ" />

        <p-button type="button" [label]="showPreview ? 'ุฅุฎูุงุก ุงููุนุงููุฉ' : 'ูุนุงููุฉ'" styleClass="p-button-secondary"
          (onClick)="togglePreview()"></p-button>

        <a class="btn btn-primary" [href]="resumeUrl" target="_blank" rel="noopener" download>
          ุชูุฒูู
        </a>
      </div>
    </div>
    }@else {
    <ng-container>
      <div class="resume-empty">
        ูุง ุชูุฌุฏ ุณูุฑุฉ ุฐุงุชูุฉ ูุฑููุนุฉ
        <p-button label="ุฑูุน ููู" styleClass="p-button-primary" [style]="{ marginLeft: '0.5rem' }"
          (onClick)="resumeFileInputEmpty.click()"></p-button>
        <input #resumeFileInputEmpty type="file" class="d-none" accept=".pdf,.doc,.docx"
          (change)="onResumeChange($event)" title="ุฑูุน ููู ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ" aria-label="ุฑูุน ููู ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ" />
      </div>
    </ng-container>
    }

    <!-- ูุนุงููุฉ PDF ููุท -->
    @if (showPreview && isPdf && resumeSafeUrl && !isResumeFromApi) {
    <!-- For local/blob files, use iframe -->
    <div class="resume-preview">
      <iframe [src]="resumeSafeUrl" title="ูุนุงููุฉ ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ"></iframe>
    </div>
    }
    @if (showPreview && isPdf && isResumeFromApi) {
    <!-- For API files, show message (file already opened in new window) -->
    <div class="resume-preview-api">
      <div class="resume-preview-message">
        <p>ูุง ูููู ุนุฑุถ ุงูููู ุฏุงุฎู ุงูุตูุญุฉ ุจุณุจุจ ุฅุนุฏุงุฏุงุช ุงูุฃูุงู. ุงููุฑ ุนูู ุงูุฒุฑ ุฃุฏูุงู ููุชุญ ุงูููู ูู ูุงูุฐุฉ ุฌุฏูุฏุฉ.</p>
        <p-button label="ูุชุญ ุงูููู ูู ูุงูุฐุฉ ุฌุฏูุฏุฉ" styleClass="p-button-primary"
          (onClick)="openResumeInNewWindow()"></p-button>
      </div>
    </div>
    }
    @if (showPreview && !isPdf && resumeUrl) {
    <div class="resume-note">
      ูุง ูููู ุนุฑุถ ุงูููู ุฏุงุฎู ุงูุตูุญุฉ ุจุณุจุจ ุฅุนุฏุงุฏุงุช ุงูุฎุงุฏู. ุงุณุชุฎุฏู ุฒุฑ ยซุชูุฒููยป.
    </div>
    }
  </div>

  <!-- ุงููุนูููุงุช ุงูุดุฎุตูุฉ -->
  <section class="form-card" dir="rtl">
    <h3 class="form-card__title"><i class="pi pi-user ml-1"></i> ุงููุนูููุงุช ุงูุดุฎุตูุฉ</h3>

    <div class="form-grid form-grid-3">
      <div class="field">
        <label class="field__label" for="first_name">ุงูุงุณู ุงูุฃูู</label>
        <input pInputText id="first_name" class="field__control" formControlName="first_name" />
      </div>

      <div class="field">
        <label class="field__label" for="last_name">ุงูุงุณู ุงูุฃุฎูุฑ</label>
        <input pInputText id="last_name" class="field__control" formControlName="last_name" />
      </div>

      <div class="field">
        <label class="field__label" for="email">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
        <input pInputText type="email" id="email" class="field__control" formControlName="email" />
      </div>

      <div class="field">
        <label class="field__label" for="phone">ุฑูู ุงููุงุชู</label>
        <input pInputText id="phone" class="field__control" formControlName="phone" />
      </div>

      <div class="field">
        <label class="field__label" for="date_of_birth">ุชุงุฑูุฎ ุงููููุงุฏ</label>
        <p-datepicker id="date_of_birth" [(ngModel)]="dateOfBirthDate" [ngModelOptions]="{standalone: true}"
          (onSelect)="onDateOfBirthSelect($event)" dateFormat="yy-mm-dd" placeholder="ุงุฎุชุฑ ุชุงุฑูุฎ ุงููููุงุฏ"
          appendTo="body" styleClass="w-full" inputStyleClass="field__control" />
      </div>

      <div class="field">
        <label class="field__label" for="location">ุงูุนููุงู</label>
        <input pInputText id="location" class="field__control" formControlName="location" />
      </div>

      <div class="field field--full">
        <label class="field__label" for="bio">ูุจุฐุฉ ูุฎุชุตุฑุฉ</label>
        <textarea pTextarea id="bio" rows="4" class="field__control" formControlName="bio"></textarea>
      </div>
    </div>
  </section>

  <!-- ุงููุนูููุงุช ุงูููููุฉ -->
  <section class="form-card" dir="rtl" [formGroup]="jobForm">
    <h3 class="form-card__title"><i class="pi pi-briefcase ml-1"></i> ุงููุนูููุงุช ุงูููููุฉ</h3>

    <div class="form-grid form-grid-3">
      <div class="field">
        <label class="field__label" for="experience_level">ุณููุงุช ุงูุฎุจุฑุฉ</label>
        <p-select [showClear]="true" id="experience_level" class="field__control" formControlName="experience_level"
          [options]="experienceLevelOptions" optionLabel="label" optionValue="value" placeholder="ุงุฎุชุฑ ูุณุชูู ุงูุฎุจุฑุฉ"
          appendTo="body" styleClass="w-full"></p-select>
      </div>

      <div class="field">
        <label class="field__label" for="education_level">ุงููุณุชูู ุงูุชุนูููู</label>
        <p-select [showClear]="true" id="education_level" class="field__control" formControlName="education_level"
          [options]="educationLevelOptions" optionLabel="label" optionValue="value" placeholder="ุงุฎุชุฑ ุงููุณุชูู ุงูุชุนูููู"
          appendTo="body" styleClass="w-full"></p-select>
      </div>

      <div class="field">
        <label class="field__label" for="preferred_job_type">ููุน ุงูุนูู ุงูููุถู</label>
        <p-select [showClear]="true" id="preferred_job_type" class="field__control" formControlName="preferred_job_type"
          [options]="jobTypeOptions" optionLabel="label" optionValue="value" placeholder="ุงุฎุชุฑ ููุน ุงูุนูู"
          appendTo="body" styleClass="w-full"></p-select>
      </div>

      <div class="field">
        <label class="field__label" for="expected_salary_min">ุงูุฑุงุชุจ ุงูุฃุฏูู</label>
        <p-inputNumber id="expected_salary_min" class="field__control" formControlName="expected_salary_min"
          [showButtons]="false" [min]="0" [useGrouping]="true" placeholder="0" styleClass="w-full"></p-inputNumber>
      </div>

      <div class="field">
        <label class="field__label" for="expected_salary_max">ุงูุฑุงุชุจ ุงูุฃุนูู</label>
        <p-inputNumber id="expected_salary_max" class="field__control" formControlName="expected_salary_max"
          [showButtons]="false" [min]="0" [useGrouping]="true" placeholder="0" styleClass="w-full"></p-inputNumber>
      </div>

      <div class="field">
        <label class="field__label" for="availability">ูุชุงุญ ููุนูู</label>
        <!-- show the clear -->
        <p-select [showClear]="true" id="availability" class="field__control" formControlName="availability"
          [options]="availabilityOptions" optionLabel="label" optionValue="value" appendTo="body"
          styleClass="w-full"></p-select>
      </div>

      <div class="field">
        <label class="field__label" for="skills">ุงูููุงุฑุงุช (ุงูุตู ุจููุงุตู)</label>
        <input pInputText id="skills" class="field__control" formControlName="skills" placeholder="JS, React, Node" />
      </div>

      <div class="field">
        <label class="field__label" for="languages">ุงููุบุงุช (ุงูุตู ุจููุงุตู)</label>
        <input pInputText id="languages" class="field__control" formControlName="languages"
          placeholder="Arabic, English" />
      </div>
    </div>
  </section>

  <div class="form-actions">
    <!-- <p-button
      type="button"
      label="ุฅูุบุงุก"
      styleClass="p-button-secondary"
      (onClick)="basicForm.reset(); jobForm.reset();"
    ></p-button> -->
    <p-button type="button" label="ุชุบููุฑ ูููุฉ ุงููุฑูุฑ" icon="pi pi-key" styleClass="p-button-outlined"
      (onClick)="openChangePasswordDialog()"></p-button>
    <p-button type="button" [label]="isSaving ? 'ุฌุงุฑู ุงูุญูุธ...' : 'ุญูุธ ุงูุชุบููุฑุงุช'" styleClass="p-button-primary"
      (onClick)="saveChanges()" [disabled]="isSaving"></p-button>
  </div>
</form>

<!-- Change Password Dialog -->
<p-dialog [(visible)]="changePasswordDialogVisible" [modal]="true" [style]="{ width: '90%', maxWidth: '500px' }"
  header="ุชุบููุฑ ูููุฉ ุงููุฑูุฑ" (onHide)="closeChangePasswordDialog()" [draggable]="false" [resizable]="false"
  [rtl]="true">
  <form (ngSubmit)="changePassword()" class="change-password-form">
    <div class="form-group">
      <label class="form-label">ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ</label>
      <div class="password-input-wrapper">
        <input [type]="showOldPassword ? 'text' : 'password'" pInputText class="w-full password-input" required
          [(ngModel)]="changePasswordForm.old_password" name="old_password" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ"
          [disabled]="changingPassword" />
        <button type="button" class="password-toggle-btn" (click)="toggleOldPasswordVisibility()"
          [disabled]="changingPassword" [attr.aria-label]="showOldPassword ? 'ุฅุฎูุงุก ูููุฉ ุงููุฑูุฑ' : 'ุฅุธูุงุฑ ูููุฉ ุงููุฑูุฑ'"
          [attr.title]="showOldPassword ? 'ุฅุฎูุงุก ูููุฉ ุงููุฑูุฑ' : 'ุฅุธูุงุฑ ูููุฉ ุงููุฑูุฑ'">
          <i [class]="showOldPassword ? 'pi pi-eye-slash' : 'pi pi-eye'" [attr.aria-hidden]="true"></i>
          <span class="sr-only">{{ showOldPassword ? 'ุฅุฎูุงุก ูููุฉ ุงููุฑูุฑ' : 'ุฅุธูุงุฑ ูููุฉ ุงููุฑูุฑ' }}</span>
        </button>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
      <div class="password-input-wrapper">
        <input [type]="showNewPassword ? 'text' : 'password'" pInputText class="w-full password-input" required
          [(ngModel)]="changePasswordForm.new_password" name="new_password" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ"
          [disabled]="changingPassword" />
        <button type="button" class="password-toggle-btn" (click)="toggleNewPasswordVisibility()"
          [disabled]="changingPassword" [attr.aria-label]="showNewPassword ? 'ุฅุฎูุงุก ูููุฉ ุงููุฑูุฑ' : 'ุฅุธูุงุฑ ูููุฉ ุงููุฑูุฑ'"
          [attr.title]="showNewPassword ? 'ุฅุฎูุงุก ูููุฉ ุงููุฑูุฑ' : 'ุฅุธูุงุฑ ูููุฉ ุงููุฑูุฑ'">
          <i [class]="showNewPassword ? 'pi pi-eye-slash' : 'pi pi-eye'" [attr.aria-hidden]="true"></i>
          <span class="sr-only">{{ showNewPassword ? 'ุฅุฎูุงุก ูููุฉ ุงููุฑูุฑ' : 'ุฅุธูุงุฑ ูููุฉ ุงููุฑูุฑ' }}</span>
        </button>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
      <div class="password-input-wrapper">
        <input [type]="showConfirmPassword ? 'text' : 'password'" pInputText class="w-full password-input" required
          [(ngModel)]="changePasswordForm.new_password_confirm" name="new_password_confirm"
          placeholder="ุฃุนุฏ ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ" [disabled]="changingPassword" />
        <button type="button" class="password-toggle-btn" (click)="toggleConfirmPasswordVisibility()"
          [disabled]="changingPassword"
          [attr.aria-label]="showConfirmPassword ? 'ุฅุฎูุงุก ูููุฉ ุงููุฑูุฑ' : 'ุฅุธูุงุฑ ูููุฉ ุงููุฑูุฑ'"
          [attr.title]="showConfirmPassword ? 'ุฅุฎูุงุก ูููุฉ ุงููุฑูุฑ' : 'ุฅุธูุงุฑ ูููุฉ ุงููุฑูุฑ'">
          <i [class]="showConfirmPassword ? 'pi pi-eye-slash' : 'pi pi-eye'" [attr.aria-hidden]="true"></i>
          <span class="sr-only">{{ showConfirmPassword ? 'ุฅุฎูุงุก ูููุฉ ุงููุฑูุฑ' : 'ุฅุธูุงุฑ ูููุฉ ุงููุฑูุฑ' }}</span>
        </button>
      </div>
    </div>

    <div class="dialog-actions">
      <p-button type="button" label="ุฅูุบุงุก" styleClass="p-button-secondary" (onClick)="closeChangePasswordDialog()"
        [disabled]="changingPassword"></p-button>
      <p-button type="submit" [label]="changingPassword ? 'ุฌุงุฑู ุงูุชุญุฏูุซ...' : 'ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ'"
        styleClass="p-button-primary" [disabled]="changingPassword" [loading]="changingPassword"></p-button>
    </div>
  </form>
</p-dialog>