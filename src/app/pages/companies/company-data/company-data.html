<div class="employer-dashboard-container">
  <app-side-bar></app-side-bar>

  <main class="dashboard-main">
    <div class="company-page">
      <!-- Page header -->
      <div class="page-header">
        <div>
          <h1 class="page-title">إدارة الشركات</h1>
          <p class="page-subtitle">
            عرض جميع شركاتك، وتعديل بياناتها أو إضافة شركة جديدة.
          </p>
        </div>
        <div class="page-actions">
          <button
            type="button"
            class="btn-primary"
            (click)="openCreateDialog()"
          >
            + إضافة شركة
          </button>
        </div>
      </div>

      <!-- Companies table -->
      <div *ngIf="companies.length; else noCompanies">
        <table class="company-table">
          <thead>
            <tr>
              <th>الشعار</th>
              <th>اسم الشركة</th>
              <th>مجال العمل</th>
              <th>الحجم</th>
              <th>سنة التأسيس</th>
              <th>البريد الإلكتروني</th>
              <th>الدولة</th>
              <th class="actions-col">إجراءات</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of companies">
              <td>
                <img
                  class="table-logo"
                  [src]="c.logo ? (c.logo.startsWith('http') ? c.logo : (baseUrl + c.logo)) : 'assets/images/company-placeholder.png'"
                  alt="Logo"
                />
              </td>
              <td>{{ c.name || c.slug }}</td>
              <td>{{ c.industry || '-' }}</td>
              <td>{{ c.size || '-' }}</td>
              <td>{{ c.founded_year || '-' }}</td>
              <td>{{ c.email || '-' }}</td>
              <td>{{ c.country || '-' }}</td>
              <td class="actions">
                <button
                  type="button"
                  class="btn-link"
                  (click)="openEditDialog(c)"
                >
                  تعديل
                </button>
                <button
                  type="button"
                  class="btn-link danger"
                  (click)="deleteCompany(c)"
                  [disabled]="deletingId === c.id"
                >
                  {{ deletingId === c.id ? 'جارٍ الحذف...' : 'حذف' }}
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-template #noCompanies>
        <div class="empty-state">
          لا توجد شركات مضافة حتى الآن.
          <button class="btn-link" (click)="openCreateDialog()">
            إضافة شركة جديدة
          </button>
        </div>
      </ng-template>

      <!-- Dialog overlay -->
      <div class="dialog-backdrop" *ngIf="dialogVisible">
        <div class="dialog">
          <div class="dialog-header">
            <div class="dialog-title">
              <img
                class="dialog-logo"
                [src]="logoPreview || 'assets/images/company-placeholder.png'"
                alt=""
              />
              <h2>{{ dialogTitle }}</h2>
            </div>
            <button type="button" class="dialog-close" (click)="closeDialog()">
              ×
            </button>
          </div>

          <form
            #companyForm="ngForm"
            class="dialog-form"
            (ngSubmit)="save(companyForm)"
          >
            <!-- Name -->
            <div class="form-group">
              <label for="name"
                >اسم الشركة <span class="required">*</span></label
              >
              <input
                pInputText
                id="name"
                name="name"
                [(ngModel)]="form.name"
                required
                #nameCtrl="ngModel"
                [class.p-invalid]="nameCtrl.invalid && (nameCtrl.dirty || nameCtrl.touched)"
                placeholder="مثال: شركة التقنيات المتقدمة"
              />
              <small
                class="p-error"
                *ngIf="nameCtrl.errors?.['required'] && (nameCtrl.dirty || nameCtrl.touched)"
              >
                الاسم مطلوب
              </small>
            </div>

            <!-- Website / Industry -->
            <div class="form-row">
              <div class="form-group">
                <label for="website">موقع الشركة</label>
                <input
                  pInputText
                  type="url"
                  id="website"
                  name="website"
                  [(ngModel)]="form.website"
                  #websiteCtrl="ngModel"
                  [class.p-invalid]="websiteCtrl.invalid && (websiteCtrl.dirty || websiteCtrl.touched)"
                  placeholder="https://example.com"
                />
                <small
                  class="p-error"
                  *ngIf="websiteCtrl.errors?.['url'] && (websiteCtrl.dirty || websiteCtrl.touched)"
                >
                  رابط غير صالح
                </small>
              </div>

              <div class="form-group">
                <label for="industry"
                  >مجال العمل <span class="required">*</span></label
                >
                <p-select
                  id="industry"
                  name="industry"
                  [options]="INDUSTRY_TYPES"
                  optionValue="value"
                  optionLabel="label"
                  placeholder="اختر مجال العمل"
                  [showClear]="true"
                  [(ngModel)]="form.industry"
                  required
                  #industryCtrl="ngModel"
                  [class.p-invalid]="industryCtrl.invalid && (industryCtrl.dirty || industryCtrl.touched)"
                >
                </p-select>
                <small
                  class="p-error"
                  *ngIf="industryCtrl.errors?.['required'] && (industryCtrl.dirty || industryCtrl.touched)"
                >
                  اختر مجال العمل
                </small>
              </div>
            </div>

            <!-- Size / Founded year -->
            <div class="form-row">
              <div class="form-group">
                <label for="size"
                  >حجم الشركة <span class="required">*</span></label
                >
                <p-select
                  id="size"
                  name="size"
                  [options]="COMPANY_SIZES"
                  optionValue="value"
                  optionLabel="label"
                  placeholder="اختر حجم الشركة"
                  [showClear]="true"
                  [(ngModel)]="form.size"
                  required
                  #sizeCtrl="ngModel"
                  [class.p-invalid]="sizeCtrl.invalid && (sizeCtrl.dirty || sizeCtrl.touched)"
                >
                </p-select>
                @if(sizeCtrl.errors?.['required'] && (sizeCtrl.dirty ||
                sizeCtrl.touched)){
                <small class="p-error"> اختر حجم الشركة </small>
                }
              </div>

              <div class="form-group">
                <label for="founded_year">سنة التأسيس</label>
                <p-inputNumber
                  inputId="founded_year"
                  name="founded_year"
                  [(ngModel)]="form.founded_year"
                  [min]="1900"
                  [max]="maxYear"
                  [showButtons]="true"
                  [useGrouping]="false"
                  #foundedCtrl="ngModel"
                  [inputStyleClass]="(foundedCtrl.invalid && (foundedCtrl.dirty || foundedCtrl.touched)) ? 'p-invalid' : ''"
                  placeholder="مثال: 2015"
                >
                </p-inputNumber>
                @if((foundedCtrl.errors?.['min'] || foundedCtrl.errors?.['max'])
                && (foundedCtrl.dirty || foundedCtrl.touched)){

                <small class="p-error">
                  يجب أن تكون بين 1900 و {{ maxYear }}
                </small>
                }
              </div>
            </div>

            <!-- Contact -->
            <div class="form-row">
              <div class="form-group">
                <label for="email">البريد الإلكتروني</label>
                <input
                  pInputText
                  type="email"
                  id="email"
                  name="email"
                  [(ngModel)]="form.email"
                  #emailCtrl="ngModel"
                  [class.p-invalid]="emailCtrl.invalid && (emailCtrl.dirty || emailCtrl.touched)"
                  placeholder="info@company.com"
                />
                @if(emailCtrl.errors?.['email'] && (emailCtrl.dirty ||
                emailCtrl.touched)){
                <small class="p-error"> بريد إلكتروني غير صالح </small>
                }
              </div>

              <div class="form-group">
                <label for="phone">رقم الهاتف</label>
                <input
                  pInputText
                  id="phone"
                  name="phone"
                  [(ngModel)]="form.phone"
                  pattern="^[0-9+\-\s()]{7,20}$"
                  maxlength="20"
                  #phoneCtrl="ngModel"
                  [class.p-invalid]="phoneCtrl.invalid && (phoneCtrl.dirty || phoneCtrl.touched)"
                  placeholder="7XXXXXXX"
                />
                @if(phoneCtrl.errors?.['pattern'] && (phoneCtrl.dirty ||
                phoneCtrl.touched)){
                <small class="p-error">
                  يُسمح بالأرقام والرموز الهاتفية فقط (7–20)
                </small>
                }
              </div>
            </div>

            <!-- Address -->
            <div class="form-row">
              <div class="form-group">
                <label for="country"
                  >الدولة <span class="required">*</span></label
                >
                <input
                  pInputText
                  id="country"
                  name="country"
                  [(ngModel)]="form.country"
                  required
                  maxlength="100"
                  #countryCtrl="ngModel"
                  [class.p-invalid]="countryCtrl.invalid && (countryCtrl.dirty || countryCtrl.touched)"
                  placeholder="اليمن"
                />
                <small
                  class="p-error"
                  *ngIf="countryCtrl.errors?.['required'] && (countryCtrl.dirty || countryCtrl.touched)"
                >
                  الدولة مطلوبة
                </small>
                <small
                  class="p-error"
                  *ngIf="countryCtrl.errors?.['maxlength'] && (countryCtrl.dirty || countryCtrl.touched)"
                >
                  الحد الأقصى 100 حرف
                </small>
              </div>

              <div class="form-group">
                <label for="city"
                  >المدينة <span class="required">*</span></label
                >
                <input
                  pInputText
                  id="city"
                  name="city"
                  [(ngModel)]="form.city"
                  required
                  maxlength="100"
                  #cityCtrl="ngModel"
                  [class.p-invalid]="cityCtrl.invalid && (cityCtrl.dirty || cityCtrl.touched)"
                  placeholder="صنعاء"
                />
                <small
                  class="p-error"
                  *ngIf="cityCtrl.errors?.['required'] && (cityCtrl.dirty || cityCtrl.touched)"
                >
                  المدينة مطلوبة
                </small>
                <small
                  class="p-error"
                  *ngIf="cityCtrl.errors?.['maxlength'] && (cityCtrl.dirty || cityCtrl.touched)"
                >
                  الحد الأقصى 100 حرف
                </small>
              </div>
            </div>

            <div class="form-group">
              <label for="address">العنوان</label>
              <input
                pInputText
                id="address"
                name="address"
                [(ngModel)]="form.address"
                maxlength="254"
                #addressCtrl="ngModel"
                [class.p-invalid]="addressCtrl.invalid && (addressCtrl.dirty || addressCtrl.touched)"
                placeholder="الحي، الشارع، تفاصيل إضافية"
              />
              <small
                class="p-error"
                *ngIf="addressCtrl.errors?.['maxlength'] && (addressCtrl.dirty || addressCtrl.touched)"
              >
                الحد الأقصى 254 حرفًا
              </small>
            </div>

            <!-- Logo / Cover -->
            <div class="form-row">
              <div class="form-group">
                <label for="logo">رابط الشعار (Logo URL)</label>
                <input
                  id="logo"
                  name="logo"
                  class="form-control"
                  [(ngModel)]="form.logo"
                  placeholder="/media/logos/company.png أو رابط كامل"
                />
              </div>
              <div class="form-group">
                <label for="cover_image">رابط صورة الغلاف</label>
                <input
                  id="cover_image"
                  name="cover_image"
                  class="form-control"
                  [(ngModel)]="form.cover_image"
                  placeholder="/media/covers/cover.jpg"
                />
              </div>
            </div>

            <!-- Logo preview upload -->
            <div class="form-group upload-group">
              <label>تحديث الشعار (اختياري للمعاينة)</label>
              <input
                type="file"
                accept="image/*"
                (change)="onLogoSelected($event)"
              />
              <small>
                هذا الاختيار فقط لمعاينة الشعار. ارفع الصورة فعلياً لمسار ثابت
                ثم ضع الرابط في الحقل أعلاه.
              </small>
            </div>

            <!-- Actions -->
            <div class="dialog-actions">
              <button type="button" class="btn-ghost" (click)="closeDialog()">
                إلغاء
              </button>
              <button
                type="submit"
                class="btn-primary"
                [disabled]="saving || companyForm.invalid"
              >
                {{ saving ? 'جارٍ الحفظ...' : (dialogMode === 'edit' ? 'حفظ
                التعديلات' : 'إنشاء الشركة') }}
              </button>
            </div>
          </form>
        </div>
      </div>
      <!-- /dialog -->
    </div>
  </main>
</div>
