<p-confirmDialog [style]="{width: '450px'}" [rtl]="true"></p-confirmDialog>
<div id="companies" class="companies-container">
  <!-- Header Skeleton -->
  @if (loading()) {
  <div class="employer-header">
    <div class="skeleton-header-content">
      <p-skeleton width="250px" height="2rem" styleClass="mb-2"></p-skeleton>
      <p-skeleton width="400px" height="1.2rem"></p-skeleton>
    </div>
    <div class="skeleton-header-actions">
      <p-skeleton width="300px" height="2.5rem" styleClass="mb-0"></p-skeleton>
      <p-skeleton width="150px" height="2.5rem" styleClass="mb-0"></p-skeleton>
    </div>
  </div>
  }

  <!-- Actual Header -->
  @if (!loading()) {
  <div class="employer-header">
    <div>
      <h1 class="employer-title">إدارة الشركات</h1>
      <p class="subtitle">عرض جميع شركاتك، وتعديل بياناتها أو إضافة شركة جديدة.</p>
    </div>
    <div class="employer-actions">
      <span class="p-input-icon-left search-input">
        <input
          pInputText
          type="text"
          [(ngModel)]="globalFilterValue"
          placeholder="بحث في الشركات..."
          (input)="onGlobalFilter($event)"
          class="p-inputtext p-component"
        />
      </span>
      <button
        type="button"
        class="btn btn-primary px-5 py-3"
        (click)="openCreateDialog()"
      >
        <i class="pi pi-plus"></i>
        إضافة شركة
      </button>
    </div>
  </div>
  }

  <div class="employer-content-card">
    <!-- Loading Skeleton -->
    @if (loading()) {
    <div class="table-skeleton">
      <div class="skeleton-header">
        <p-skeleton width="100%" height="3rem" styleClass="mb-2"></p-skeleton>
      </div>
      <div class="skeleton-table">
        @for (item of [1,2,3,4,5]; track item) {
        <div class="skeleton-row">
          <p-skeleton width="80px" height="60px" shape="rectangle" styleClass="skeleton-logo"></p-skeleton>
          <p-skeleton width="180px" height="1.5rem" styleClass="skeleton-cell"></p-skeleton>
          <p-skeleton width="150px" height="1.5rem" styleClass="skeleton-cell"></p-skeleton>
          <p-skeleton width="120px" height="1.5rem" styleClass="skeleton-cell"></p-skeleton>
          <p-skeleton width="120px" height="1.5rem" styleClass="skeleton-cell"></p-skeleton>
          <p-skeleton width="200px" height="1.5rem" styleClass="skeleton-cell"></p-skeleton>
          <p-skeleton width="120px" height="1.5rem" styleClass="skeleton-cell"></p-skeleton>
          <p-skeleton width="160px" height="2.5rem" styleClass="skeleton-cell"></p-skeleton>
        </div>
        }
      </div>
      <div class="skeleton-pagination">
        <p-skeleton width="300px" height="2rem"></p-skeleton>
      </div>
    </div>
    }

    <!-- Actual Table -->
    @if (!loading()) {
    <p-table
      #dt
      [value]="filteredCompanies()"
      [paginator]="true"
      [rows]="5"
      [rowsPerPageOptions]="[5, 10, 25]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="عرض {first} إلى {last} من {totalRecords} شركة"
      [rowHover]="true"
      styleClass="p-datatable-striped"
      responsiveLayout="scroll"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 80px">الشعار</th>
          <th pSortableColumn="name" style="min-width: 180px">
            اسم الشركة <p-sortIcon field="name"></p-sortIcon>
          </th>
          <th pSortableColumn="industry" style="min-width: 150px">
            مجال العمل <p-sortIcon field="industry"></p-sortIcon>
          </th>
          <th pSortableColumn="size" style="min-width: 120px">
            الحجم <p-sortIcon field="size"></p-sortIcon>
          </th>
          <th pSortableColumn="founded_year" style="min-width: 120px">
            سنة التأسيس <p-sortIcon field="founded_year"></p-sortIcon>
          </th>
          <th pSortableColumn="email" style="min-width: 200px">
            البريد الإلكتروني <p-sortIcon field="email"></p-sortIcon>
          </th>
          <th pSortableColumn="country" style="min-width: 120px">
            الدولة <p-sortIcon field="country"></p-sortIcon>
          </th>
          <th style="width: 160px">إجراءات</th>
        </tr>
        <tr>
          <th></th>
          <th></th>
          <th>
            <p-select
              [options]="INDUSTRY_TYPES"
              optionLabel="label"
              optionValue="value"
              appendTo="body"
              [(ngModel)]="filterIndustry"
              (onChange)="applyFilters()"
              placeholder="الكل"
              [showClear]="true"
              styleClass="p-column-filter"
            >
            </p-select>
          </th>
          <th>
            <p-select
              [options]="COMPANY_SIZES"
              optionLabel="label"
              optionValue="value"
              appendTo="body"
              [(ngModel)]="filterSize"
              (onChange)="applyFilters()"
              placeholder="الكل"
              [showClear]="true"
              styleClass="p-column-filter"
            >
            </p-select>
          </th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-company>
        <tr>
          <td>
            <img
              class="table-logo"
              [src]="getCompanyLogo(company.logo)"
              [alt]="company.name"
              [title]="company.name || 'شعار الشركة'"
              title="Company logo"
              (error)="handleImageError($event)"
            />
          </td>
          <td>
            <span class="company-name">{{ company.name || company.slug }}</span>
          </td>
          <td>{{ getIndustryLabel(company.industry || '') }}</td>
          <td>{{ getSizeLabel(company.size || '') }}</td>
          <td>{{ company.founded_year || '-' }}</td>
          <td>{{ company.email || '-' }}</td>
          <td>{{ company.country || '-' }}</td>
          <td>
            <div class="action-buttons">
              <button
                pButton
                type="button"
                icon="pi pi-pencil"
                class="p-button-rounded p-button-text p-button-info"
                (click)="openEditDialog(company)"
                pTooltip="تعديل"
                tooltipPosition="top"
                title="تعديل"
                aria-label="تعديل"
              ></button>
              <button
                pButton
                type="button"
                icon="pi pi-trash"
                class="p-button-rounded p-button-text p-button-danger"
                (click)="deleteCompany(company)"
                [disabled]="deletingId === company.id"
                [loading]="deletingId === company.id"
                pTooltip="حذف"
                tooltipPosition="top"
                title="حذف"
                aria-label="حذف"
              ></button>
            </div>
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="empty-message">
            <div class="empty-state-table">
              <i class="pi pi-inbox empty-icon"></i>
              <p>لا توجد شركات مضافة حتى الآن.</p>
              <button class="btn btn-primary" (click)="openCreateDialog()">
                <i class="pi pi-plus"></i>
                إضافة شركة جديدة
              </button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
    }
  </div>

  <!-- Dialog overlay -->
  <div class="dialog-backdrop" *ngIf="dialogVisible">
    <div class="dialog">
      <div class="dialog-header">
        <div class="dialog-title">
            <img
              class="dialog-logo"
              [src]="logoPreview || defaultPlaceholder"
              alt=""
            />
          <h2>{{ dialogTitle }}</h2>
        </div>
        <button type="button" class="dialog-close" (click)="closeDialog()">
          ×
        </button>
      </div>

      <form
        #companyForm="ngForm"
        class="dialog-form"
        (ngSubmit)="save(companyForm)"
      >
        <!-- Name, Industry, Size -->
        <div class="form-row form-row-3">
          <div class="form-group">
            <label for="name"
              >اسم الشركة <span class="required">*</span></label
            >
            <input
              pInputText
              id="name"
              name="name"
              [(ngModel)]="form.name"
              required
              #nameCtrl="ngModel"
              [class.p-invalid]="nameCtrl.invalid && (nameCtrl.dirty || nameCtrl.touched)"
              placeholder="مثال: شركة التقنيات المتقدمة"
            />
            <small
              class="p-error"
              *ngIf="nameCtrl.errors?.['required'] && (nameCtrl.dirty || nameCtrl.touched)"
            >
              الاسم مطلوب
            </small>
          </div>

          <div class="form-group">
            <label for="industry"
              >مجال العمل <span class="required">*</span></label
            >
            <p-select
              id="industry"
              name="industry"
              [options]="INDUSTRY_TYPES"
              optionValue="value"
              optionLabel="label"
              placeholder="اختر مجال العمل"
              [showClear]="true"
              [(ngModel)]="form.industry"
              required
              #industryCtrl="ngModel"
              [class.p-invalid]="industryCtrl.invalid && (industryCtrl.dirty || industryCtrl.touched)"
            >
            </p-select>
            <small
              class="p-error"
              *ngIf="industryCtrl.errors?.['required'] && (industryCtrl.dirty || industryCtrl.touched)"
            >
              اختر مجال العمل
            </small>
          </div>

          <div class="form-group">
            <label for="size"
              >حجم الشركة <span class="required">*</span></label
            >
            <p-select
              id="size"
              name="size"
              [options]="COMPANY_SIZES"
              optionValue="value"
              optionLabel="label"
              placeholder="اختر حجم الشركة"
              [showClear]="true"
              [(ngModel)]="form.size"
              required
              #sizeCtrl="ngModel"
              [class.p-invalid]="sizeCtrl.invalid && (sizeCtrl.dirty || sizeCtrl.touched)"
            >
            </p-select>
            @if(sizeCtrl.errors?.['required'] && (sizeCtrl.dirty ||
            sizeCtrl.touched)){
            <small class="p-error"> اختر حجم الشركة </small>
            }
          </div>
        </div>

        <!-- Founded Year, Phone, Email -->
        <div class="form-row form-row-3">
          <div class="form-group">
            <label for="founded_year">سنة التأسيس</label>
            <p-inputNumber
              inputId="founded_year"
              name="founded_year"
              [(ngModel)]="form.founded_year"
              [min]="1900"
              [max]="maxYear()"
              [showButtons]="true"
              [useGrouping]="false"
              #foundedCtrl="ngModel"
              [inputStyleClass]="(foundedCtrl.invalid && (foundedCtrl.dirty || foundedCtrl.touched)) ? 'p-invalid' : ''"
              placeholder="مثال: 2015"
            >
            </p-inputNumber>
            @if((foundedCtrl.errors?.['min'] || foundedCtrl.errors?.['max'])
            && (foundedCtrl.dirty || foundedCtrl.touched)){

            <small class="p-error">
              يجب أن تكون بين 1900 و {{ maxYear() }}
            </small>
            }
          </div>

          <div class="form-group">
            <label for="phone">رقم الهاتف</label>
            <input
              pInputText
              id="phone"
              name="phone"
              [(ngModel)]="form.phone"
              pattern="^[0-9+\-\s()]{7,20}$"
              maxlength="20"
              #phoneCtrl="ngModel"
              [class.p-invalid]="phoneCtrl.invalid && (phoneCtrl.dirty || phoneCtrl.touched)"
              placeholder="7XXXXXXX"
            />
            @if(phoneCtrl.errors?.['pattern'] && (phoneCtrl.dirty ||
            phoneCtrl.touched)){
            <small class="p-error">
              يُسمح بالأرقام والرموز الهاتفية فقط (7–20)
            </small>
            }
          </div>

          <div class="form-group">
            <label for="email">البريد الإلكتروني <span class="required">*</span></label>
            <input
              pInputText
              type="email"
              id="email"
              name="email"
              maxlength="254"
              required
              [(ngModel)]="form.email"
              #emailCtrl="ngModel"
              [class.p-invalid]="emailCtrl.invalid && (emailCtrl.dirty || emailCtrl.touched)"
              placeholder="info@company.com"
            />
            @if(emailCtrl.errors?.['email'] && (emailCtrl.dirty ||
            emailCtrl.touched)){
            <small class="p-error"> بريد إلكتروني غير صالح </small>
            }
            <!-- this feild is required -->
            @if(emailCtrl.errors?.['required'] && (emailCtrl.dirty ||
            emailCtrl.touched)){
            <small class="p-error"> هذا الحقل مطلوب </small>
            }
          </div>
        </div>

        <!-- Description / Website -->
          <div class="form-group">
            <label for="description">وصف الشركة<span class="required">*</span></label
            >
            <textarea
              pTextarea
              id="description"
              name="description"
              [(ngModel)]="form.description"
              rows="2"
              required
              #descriptionCtrl="ngModel"
              [class.p-invalid]="descriptionCtrl.invalid && (descriptionCtrl.dirty || descriptionCtrl.touched)"
              placeholder="قدم نبذة مختصرة عن الشركة ونشاطها."
            ></textarea>
            <small
              class="p-error"
              *ngIf="descriptionCtrl.errors?.['required'] && (descriptionCtrl.dirty || descriptionCtrl.touched)"
            >
             هذا الحقل مطلوب
            </small>


        </div>

        <!-- Address -->
        <div class="form-row form-row-3">
          <div class="form-group">
            <label for="country"
              >الدولة <span class="required">*</span></label
            >
            <input
              pInputText
              id="country"
              name="country"
              [(ngModel)]="form.country"
              required
              maxlength="100"
              #countryCtrl="ngModel"
              [class.p-invalid]="countryCtrl.invalid && (countryCtrl.dirty || countryCtrl.touched)"
              placeholder="اليمن"
            />
            <small
              class="p-error"
              *ngIf="countryCtrl.errors?.['required'] && (countryCtrl.dirty || countryCtrl.touched)"
            >
              الدولة مطلوبة
            </small>
            <small
              class="p-error"
              *ngIf="countryCtrl.errors?.['maxlength'] && (countryCtrl.dirty || countryCtrl.touched)"
            >
              الحد الأقصى 100 حرف
            </small>
          </div>
          <div class="form-group">
          <label for="website">موقع الشركة</label>
          <input
            pInputText
            type="url"
            id="website"
            name="website"
            [(ngModel)]="form.website"
            #websiteCtrl="ngModel"
            [class.p-invalid]="websiteCtrl.invalid && (websiteCtrl.dirty || websiteCtrl.touched)"
            placeholder="https://example.com"
          />
          <small
            class="p-error"
            *ngIf="websiteCtrl.errors?.['url'] && (websiteCtrl.dirty || websiteCtrl.touched)"
          >
            رابط غير صالح
          </small>
        </div>
          <div class="form-group">
            <label for="city"
              >المدينة <span class="required">*</span></label
            >
            <input
              pInputText
              id="city"
              name="city"
              [(ngModel)]="form.city"
              required
              maxlength="100"
              #cityCtrl="ngModel"
              [class.p-invalid]="cityCtrl.invalid && (cityCtrl.dirty || cityCtrl.touched)"
              placeholder="صنعاء"
            />
            <small
              class="p-error"
              *ngIf="cityCtrl.errors?.['required'] && (cityCtrl.dirty || cityCtrl.touched)"
            >
              المدينة مطلوبة
            </small>
            <small
              class="p-error"
              *ngIf="cityCtrl.errors?.['maxlength'] && (cityCtrl.dirty || cityCtrl.touched)"
            >
              الحد الأقصى 100 حرف
            </small>
          </div>
        </div>

          <div class="form-group">
            <label for="address">العنوان</label>
            <input
              pInputText
              id="address"
              name="address"
              [(ngModel)]="form.address"
              maxlength="254"
              #addressCtrl="ngModel"
              [class.p-invalid]="addressCtrl.invalid && (addressCtrl.dirty || addressCtrl.touched)"
              placeholder="الحي، الشارع، تفاصيل إضافية"
            />
            <small
              class="p-error"
              *ngIf="addressCtrl.errors?.['maxlength'] && (addressCtrl.dirty || addressCtrl.touched)"
            >
              الحد الأقصى 254 حرفًا
            </small>
        </div>

        <!-- Logo upload -->
        <div class="form-group upload-group">
          <label for="logo-file">
            شعار الشركة
            @if (logoPreview) {
              <span class="file-selected">(تم اختيار ملف)</span>
            }
          </label>
          <input
            id="logo-file"
            type="file"
            accept="image/*"
            (change)="onLogoSelected($event)"
            class="file-input"
          />
          @if (logoPreview) {
            <div class="image-preview">
              <img [src]="logoPreview" alt="معاينة الشعار" class="preview-image" />
              <button 
                type="button" 
                class="remove-image-btn"
                (click)="removeLogoPreview()"
                title="إزالة الصورة"
              >
                <i class="pi pi-times"></i>
              </button>
            </div>
          }
          <small class="help-text">
            اختر صورة شعار الشركة (PNG, JPG, GIF - الحد الأقصى 5MB)
          </small>
        </div>

        <!-- Cover image upload -->
        <div class="form-group upload-group">
          <label for="cover-file">
            صورة الغلاف
            @if (coverPreview) {
              <span class="file-selected">(تم اختيار ملف)</span>
            }
          </label>
          <input
            id="cover-file"
            type="file"
            accept="image/*"
            (change)="onCoverSelected($event)"
            class="file-input"
          />
          @if (coverPreview) {
            <div class="image-preview">
              <img [src]="coverPreview" alt="معاينة صورة الغلاف" class="preview-image" />
              <button 
                type="button" 
                class="remove-image-btn"
                (click)="removeCoverPreview()"
                title="إزالة الصورة"
              >
                <i class="pi pi-times"></i>
              </button>
            </div>
          }
          <small class="help-text">
            اختر صورة غلاف للشركة (PNG, JPG, GIF - الحد الأقصى 5MB)
          </small>
        </div>

        <!-- Actions -->
        <div class="dialog-actions">
          <button type="button" class="btn-ghost" (click)="closeDialog()">
            إلغاء
          </button>
          <button
            type="submit"
            class="btn-primary"
            [disabled]="saving || companyForm.invalid"
          >
            {{ saving ? 'جارٍ الحفظ...' : (dialogMode === 'edit' ? 'حفظ  التعديلات' : 'إنشاء الشركة') }}
          </button>
        </div>
      </form>
    </div>
  </div>
  <!-- /dialog -->
</div>