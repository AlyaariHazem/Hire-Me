<!-- English: Render only when jobDetail is loaded -->
@if (jobDetail; as job) {
<section class="job-details-section">
  <div class="container">
    <div class="job-details-container">
      <!-- Main Content -->
      <main class="job-main-content">
        <!-- Job Header -->
        <div class="job-header">
          <div class="job-header-top">
            <img class="company-logo-large" [src]="job.company.logo || 'images/company-logo-1.jpg'"
              [alt]="job.company.name || 'شعار الشركة'" title="شعار الشركة" />

            <div style="flex-grow: 1">
              <h1 class="job-title-large">{{ job.title }}</h1>
              <p class="company-name-large">{{ job.company.name }}</p>

              <div class="job-meta-large">
                <div class="meta-item">
                  <span class="meta-icon"><i class="pi pi-map-marker"></i></span>
                  <span>
                    {{ job.city || job.company.city || 'غير محدد' }}،
                    {{ job.company.country || 'غير محدد' }}
                  </span>
                </div>

                <div class="meta-item">
                  <span class="meta-icon"><i class="pi pi-money-bill"></i></span>
                  <span>
                    {{ formatSalary(job.salary_min, job.salary_max) }}
                  </span>
                </div>

                <div class="meta-item">
                  <span class="meta-icon"><i class="pi pi-clock"></i></span>
                  <span>{{ getJobTypeLabel(job.job_type) }}</span>
                </div>

                <div class="meta-item">
                  <span class="meta-icon"><i class="pi pi-calendar"></i></span>
                  <span>
                    نُشرت في {{ job.created_at | date: 'mediumDate' }}
                  </span>
                </div>

                <div class="meta-item">
                  <span class="meta-icon"><i class="pi pi-users"></i></span>
                  <span>{{ job.applications_count || 0 }} متقدم</span>
                </div>

                <div class="meta-item">
                  <span class="meta-icon"><i class="pi pi-eye"></i></span>
                  <span>{{ job.views_count || 0 }} مشاهدة</span>
                </div>
              </div>
            </div>
          </div>

          <div class="job-actions-large">
            <button type="button" class="btn btn-large btn-primary"
              [ngClass]="{ 'btn-primary': showApplicationForm, 'btn-secondary': !showApplicationForm }"
              (click)="toggleApplicationForm()">
              تقديم الآن
            </button>

            <button type="button" class="btn btn-large btn-secondary save-btn" (click)="onSaveJob()">
              {{ job.is_bookmarked ? 'إزالة من المحفوظات' : 'حفظ الوظيفة' }}
            </button>

            <button type="button" class="btn btn-large btn-secondary" (click)="onShareJob()">
              مشاركة
            </button>
          </div>
        </div>

        <!-- Application Form -->
        @if (showApplicationForm) {
        <app-apply-job [jobId]="job.id" [jobTitle]="job.title" [job]="job" [onClose]="toggleApplicationForm.bind(this)">
        </app-apply-job>
        }

        <!-- Job Description -->
        @if (job.description) {
        <div class="content-section">
          <h2 class="section-title">وصف الوظيفة</h2>
          <div class="content-text">
            <p>{{ job.description }}</p>
          </div>
        </div>
        }

        <!-- Requirements -->
        @if (job.requirements) {
        <div class="content-section">
          <h2 class="section-title">المتطلبات والمؤهلات</h2>
          <div class="content-text">
            <!-- English: Split by newline if backend stores multi-line text -->
            <ul class="requirements-list">
              @for (item of job.requirements.split('\n'); track item) {
              <li>
                {{ item }}
              </li>
              }
            </ul>
          </div>
        </div>
        }

        <!-- Responsibilities -->
        @if (job.responsibilities) {
        <div class="content-section">
          <h2 class="section-title">المسؤوليات الوظيفية</h2>
          <div class="content-text">
            <ul class="requirements-list">
              @for (item of job.responsibilities.split('\n'); track item) {
              <li>
                {{ item }}
              </li>
              }
            </ul>
          </div>
        </div>
        }

        <!-- Benefits -->
        @if (job.benefits) {
        <div class="content-section">
          <h2 class="section-title">المزايا والحوافز</h2>
          <div class="content-text">
            <ul class="benefits-list">
              @for (item of job.benefits.split('\n'); track item) {
              <li>
                {{ item }}
              </li>
              }
            </ul>
          </div>
        </div>
        }

        <!-- Company About (fallback to company description) -->
        @if (job.company.description) {
        <div class="content-section">
          <h2 class="section-title">عن الشركة</h2>
          <div class="content-text">
            <p>{{ job.company.description }}</p>
          </div>
        </div>
        }
      </main>

      <!-- Sidebar -->
      <aside class="job-sidebar">
        <!-- Job Details Card -->
        <div class="sidebar-card">
          <h3 class="sidebar-title">تفاصيل الوظيفة</h3>
          <ul class="job-details-list">
            <li>
              <span class="detail-label">نوع الوظيفة</span>
              <span class="detail-value">{{ getJobTypeLabel(job.job_type) }}</span>
            </li>

            <li>
              <span class="detail-label">مستوى الخبرة</span>
              <span class="detail-value">{{ getExperienceLevelLabel(job.experience_level) }}</span>
            </li>

            <li>
              <span class="detail-label">الراتب</span>
              <span class="detail-value">{{ formatSalary(job.salary_min, job.salary_max) }}</span>
            </li>

            <li>
              <span class="detail-label">الموقع</span>
              <span class="detail-value">
                {{ job.city || job.company.city || 'غير محدد' }}،
                {{ job.company.country || 'غير محدد' }}
              </span>
            </li>

            <li>
              <span class="detail-label">تاريخ النشر</span>
              <span class="detail-value">{{ job.created_at | date: 'mediumDate' }}</span>
            </li>

            @if (job.application_deadline) {
            <li>
              <span class="detail-label">آخر موعد للتقديم</span>
              <span class="detail-value">{{ job.application_deadline | date: 'mediumDate' }}</span>
            </li>
            }
          </ul>
        </div>

        <!-- Required Skills -->
        @if (job.skills; as skills) {
        <div class="sidebar-card">
          <h3 class="sidebar-title">المهارات المطلوبة</h3>
          <div class="skills-list">
            <!-- English: Attempt to split by comma first, fallback to whitespace -->
            @if (skills.includes(',')) {
            @for (s of skills.split(','); track s) {
            <span class="skill-tag">
              {{ s.trim() }}
            </span>
            }
            } @else {
            @for (s of skills.split(' '); track s) {
            <span class="skill-tag">
              {{ s.trim() }}
            </span>
            }
            }
          </div>
        </div>
        }

        <!-- Company Info Card -->
        <div class="sidebar-card">
          <h3 class="sidebar-title">معلومات الشركة</h3>
          <div style="text-align: center; margin-bottom: 1rem">
            <img [src]="job.company.logo || 'images/company-logo-1.jpg'" [alt]="job.company.name || 'شعار الشركة'"
              title="شعار الشركة"
              style="width: 80px; height: 80px; border-radius: var(--radius-lg); object-fit: cover;" />
          </div>

          <ul class="job-details-list">
            <li>
              <span class="detail-label">اسم الشركة</span>
              <span class="detail-value">{{ job.company.name }}</span>
            </li>
            @if (job.company.size) {
            <li>
              <span class="detail-label">حجم الشركة</span>
              <span class="detail-value">{{ job.company.size }}</span>
            </li>
            }
            @if (job.company.industry) {
            <li>
              <span class="detail-label">القطاع</span>
              <span class="detail-value">{{ job.company.industry }}</span>
            </li>
            }
            @if (job.company.founded_year) {
            <li>
              <span class="detail-label">سنة التأسيس</span>
              <span class="detail-value">{{ job.company.founded_year }}</span>
            </li>
            }
          </ul>

          <div style="margin-top: 1rem">
            <a [routerLink]="['/company', job.company.slug]" class="btn btn-secondary" style="width: 100%">
              عرض ملف الشركة
            </a>
          </div>
        </div>

        <!-- Similar Jobs -->
        @if (similarJobs.length > 0) {
        <div class="sidebar-card">
          <h3 class="sidebar-title">وظائف مشابهة</h3>
          <div class="similar-jobs">
            @for (job of similarJobs; track job.id) {
            <a (click)="navigateToJob(job.slug)" class="similar-job-card"
              style="text-decoration: none; color: inherit; display: block;">
              <img [src]="job.company.logo || 'assets/images/company-placeholder.png'"
                [alt]="job.company.name || 'شعار الشركة'" title="شعار الشركة" class="similar-job-logo" />
              <div class="similar-job-info">
                <h4>{{ job.title }}</h4>
                <p>{{ job.company.name }}</p>
                <p style="color: var(--primary-color); font-weight: 500;">
                  {{ formatSimilarJobSalary(job) }}
                </p>
              </div>
            </a>
            }
          </div>
        </div>
        }
      </aside>
    </div>
  </div>
</section>
}

<!-- Loading Skeleton -->
@if (!jobDetail && isLoading) {
<section class="job-details-section">
  <div class="container">
    <div class="job-details-container">
      <!-- Main Content Skeleton -->
      <main class="job-main-content">
        <!-- Job Header Skeleton -->
        <div class="job-header">
          <div class="job-header-top">
            <p-skeleton width="80px" height="80px" shape="rectangle" styleClass="skeleton-logo"></p-skeleton>
            <div class="skeleton-header-content">
              <p-skeleton width="60%" height="2rem" styleClass="mb-2"></p-skeleton>
              <p-skeleton width="40%" height="1.5rem" styleClass="mb-3"></p-skeleton>
              <div class="job-meta-large">
                @for (item of [1,2,3,4,5,6]; track item) {
                <div class="meta-item">
                  <p-skeleton width="24px" height="24px" shape="circle" styleClass="mb-0"></p-skeleton>
                  <p-skeleton width="120px" height="1rem" styleClass="mb-0"></p-skeleton>
                </div>
                }
              </div>
            </div>
          </div>
          <div class="job-actions-large">
            <p-skeleton width="120px" height="3rem" styleClass="mb-0"></p-skeleton>
            <p-skeleton width="150px" height="3rem" styleClass="mb-0"></p-skeleton>
            <p-skeleton width="100px" height="3rem" styleClass="mb-0"></p-skeleton>
          </div>
        </div>

        <!-- Content Sections Skeleton -->
        @for (item of [1,2,3,4]; track item) {
        <div class="content-section">
          <p-skeleton width="200px" height="1.8rem" styleClass="mb-3"></p-skeleton>
          <p-skeleton width="100%" height="1rem" styleClass="mb-2"></p-skeleton>
          <p-skeleton width="95%" height="1rem" styleClass="mb-2"></p-skeleton>
          <p-skeleton width="90%" height="1rem" styleClass="mb-0"></p-skeleton>
        </div>
        }
      </main>

      <!-- Sidebar Skeleton -->
      <aside class="job-sidebar">
        <!-- Job Details Card Skeleton -->
        <div class="sidebar-card">
          <p-skeleton width="150px" height="1.5rem" styleClass="mb-3"></p-skeleton>
          <ul class="job-details-list">
            @for (item of [1,2,3,4,5]; track item) {
            <li>
              <p-skeleton width="120px" height="1rem" styleClass="mb-0"></p-skeleton>
              <p-skeleton width="100px" height="1rem" styleClass="mb-0"></p-skeleton>
            </li>
            }
          </ul>
        </div>

        <!-- Skills Card Skeleton -->
        <div class="sidebar-card">
          <p-skeleton width="150px" height="1.5rem" styleClass="mb-3"></p-skeleton>
          <div class="skills-list">
            @for (item of [1,2,3,4]; track item) {
            <p-skeleton width="80px" height="2rem" styleClass="mb-0"></p-skeleton>
            }
          </div>
        </div>

        <!-- Company Info Card Skeleton -->
        <div class="sidebar-card">
          <p-skeleton width="150px" height="1.5rem" styleClass="mb-3"></p-skeleton>
          <div style="text-align: center; margin-bottom: 1rem">
            <p-skeleton width="80px" height="80px" shape="circle" styleClass="mb-0"></p-skeleton>
          </div>
          <ul class="job-details-list">
            @for (item of [1,2,3,4]; track item) {
            <li>
              <p-skeleton width="100px" height="1rem" styleClass="mb-0"></p-skeleton>
              <p-skeleton width="80px" height="1rem" styleClass="mb-0"></p-skeleton>
            </li>
            }
          </ul>
          <p-skeleton width="100%" height="2.5rem" styleClass="mb-0 mt-2"></p-skeleton>
        </div>

        <!-- Similar Jobs Card Skeleton -->
        <div class="sidebar-card">
          <p-skeleton width="150px" height="1.5rem" styleClass="mb-3"></p-skeleton>
          <div class="similar-jobs">
            @for (item of [1,2,3]; track item) {
            <div class="similar-job-card skeleton-similar-job">
              <p-skeleton width="50px" height="50px" shape="circle" styleClass="skeleton-logo"></p-skeleton>
              <div class="similar-job-info">
                <p-skeleton width="150px" height="1.2rem" styleClass="mb-2"></p-skeleton>
                <p-skeleton width="120px" height="1rem" styleClass="mb-2"></p-skeleton>
                <p-skeleton width="100px" height="1rem" styleClass="mb-0"></p-skeleton>
              </div>
            </div>
            }
          </div>
        </div>
      </aside>
    </div>
  </div>
</section>
}