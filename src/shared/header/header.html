<header class="header">
  <p-confirmDialog key="logout" [style]="{width: '350px'}" rejectButtonStyleClass="p-button-outlined"></p-confirmDialog>
  <nav class="navbar" [class.mobile-menu-open]="mobileOpen">
    <div class="container">
      <!-- Brand -->
      <div class="navbar-brand">
        <a [routerLink]="homeLink()">
          <img 
            [src]="'images/HireMe.png'" 
            alt="منصة التوظيف" 
            class="logo"
            (error)="handleLogoError($event)"
          />
        </a>
      </div>

      <!-- Main nav links (shared) -->
      <ul class="navbar-nav" id="primary-nav" (click)="closeMobileMenu()">
        <!-- Close Button for Mobile Menu - Only show when menu is open -->
        @if (mobileOpen) {
          <li class="nav-item mobile-close-item">
            <button 
              class="mobile-close-btn" 
              type="button"
              (click)="closeMobileMenu()"
              aria-label="إغلاق القائمة"
            >
              <i class="pi pi-times"></i>
              <span>إغلاق</span>
            </button>
          </li>
        }
          <li class="nav-item">
          <a class="nav-link" (click)="routeToJobs()" pRipple>
            <i class="pi pi-briefcase"></i>
            <span class="pr-2">الوظائف</span>
          </a>
        </li>
        <li class="nav-item">
          <a (click)="routeToCompanies()" class="nav-link" pRipple>
            <i class="pi pi-building"></i>
            <span>الشركات</span>
          </a>
        </li>
        <li class="nav-item">
          <a (click)="notImplemented()" class="nav-link" pRipple>
            <i class="pi pi-dollar"></i>
            <span>الرواتب</span>
          </a>
        </li>
        <li class="nav-item">
          <a (click)="notImplemented()" class="nav-link" pRipple>
            <i class="pi pi-book"></i>
            <span>الموارد</span>
          </a>
        </li>
        @if (isLoggedIn() && role() === 'jobseeker') {
        <li role="none" (click)="$event.stopPropagation()">
          <p-button
            label="تسجيل الخروج"
            icon="pi pi-sign-out"
            (onClick)="logout()"
            styleClass="p-button-text p-button-danger"
            pRipple
          ></p-button>
        </li>
        }
      </ul>

      <!-- Right side actions (change per mode) -->
      <div class="navbar-actions" dir="rtl" (click)="closeMobileMenu()">
        <!-- ========== Public header (login / register) ========== -->
         @if (!isLoggedIn()) {
            <a routerLink="/login" routerLinkActive="active" [routerLinkActiveOptions]="{exact: false}">
              <p-button 
                label="تسجيل الدخول" 
                icon="pi pi-sign-in"
                styleClass="p-button-outlined"
              ></p-button>
            </a>
            <a routerLink="/register" routerLinkActive="active" [routerLinkActiveOptions]="{exact: false}">
              <p-button 
                label="إنشاء حساب" 
                icon="pi pi-user-plus"
                styleClass="p-button-outlined"
              ></p-button>
            </a>
          }

        <!-- ========== Employer header ========== -->
         @if (isLoggedIn() && role() === 'employer') {
           <div class="navbar-actions company" (click)="$event.stopPropagation()" #menuRoot>
             <div
               class="user-menu"
               *ngIf="isEmployerMenuOpen"
               (click)="$event.stopPropagation()"
             >
               <a class="user-menu-item" (click)="navigate('dashboard')">
                 <i class="pi pi-chart-bar"></i>
                 <span>لوحة التحكم</span>
               </a>
               <a class="user-menu-item" (click)="navigate('profile')">
                 <i class="pi pi-building"></i>
                 <span>ملف الشركة</span>
               </a>
               <a class="user-menu-item" (click)="navigate('user-edit')">
                 <i class="pi pi-user-edit"></i>
                 <span>تعديل الملف الشخصي</span>
               </a>
               <a class="user-menu-item" (click)="navigate('post-job')">
                 <i class="pi pi-plus-circle"></i>
                 <span>نشر وظيفة</span>
               </a>
               <!-- <a class="user-menu-item" (click)="navigate('employer-settings')">
                 <i class="pi pi-cog"></i>
                 <span>الإعدادات</span>
               </a> -->
               <a class="user-menu-item" (click)="openChangePasswordDialog()">
                 <i class="pi pi-key"></i>
                 <span>تغيير كلمة المرور</span>
               </a>
               <p-divider></p-divider>
               <a class="user-menu-item-logout" (click)="logout()">
                 <i class="pi pi-sign-out"></i>
                 <span>تسجيل الخروج</span>
               </a>
             </div>
             <button
               type="button"
               class="p-button p-button-outlined company-menu-btn"
               (click)="toggleEmployerMenu($event)"
               pRipple
             >
               @if (logoUrl()) {
                 <p-avatar 
                   [image]="logoUrl()" 
                   shape="circle"
                   size="normal"
                   styleClass="company-logo-small-avatar"
                   (onImageError)="handleLogoError($event)"
                 ></p-avatar>
               } @else {
                 <p-avatar 
                   [label]="companyName().charAt(0)"
                   shape="circle"
                   size="normal"
                   styleClass="company-logo-small-avatar"
                 ></p-avatar>
               }
               <span>{{ companyName() }}</span>
               <i class="pi pi-chevron-down"></i>
             </button>
           </div>
         }
      </div>

      <!-- Mobile Menu Toggle -->
      <button
        class="mobile-menu-toggle"
        type="button"
        (click)="toggleMobileMenu()"
        [class.active]="mobileOpen"
        aria-label="فتح القائمة"
        [attr.aria-expanded]="mobileOpen"
        aria-controls="primary-nav"
      >
        <span></span><span></span><span></span>
      </button>
    </div>
  </nav>

  <!-- Backdrop for mobile -->
   @if(mobileOpen){
     <div
       class="mobile-backdrop"
       (click)="closeMobileMenu()"
     ></div>
   }

  <!-- Change Password Dialog -->
  <p-dialog
    [(visible)]="changePasswordDialogVisible"
    [modal]="true"
    [style]="{ width: '90%', maxWidth: '500px' }"
    header="تغيير كلمة المرور"
    (onHide)="closeChangePasswordDialog()"
    [draggable]="false"
    [resizable]="false"
    [rtl]="true"
  >
    <form (ngSubmit)="changePassword()" class="change-password-form">
      <div class="form-group">
        <label class="form-label">كلمة المرور الحالية</label>
        <div class="password-input-wrapper">
          <input
            [type]="showOldPassword ? 'text' : 'password'"
            pInputText
            class="w-full password-input"
            required
            [(ngModel)]="changePasswordForm.old_password"
            name="old_password"
            placeholder="أدخل كلمة المرور الحالية"
            [disabled]="changingPassword"
          />
          <button
            type="button"
            class="password-toggle-btn"
            (click)="toggleOldPasswordVisibility()"
            [disabled]="changingPassword"
            [attr.aria-label]="showOldPassword ? 'إخفاء كلمة المرور' : 'إظهار كلمة المرور'"
            [attr.title]="showOldPassword ? 'إخفاء كلمة المرور' : 'إظهار كلمة المرور'"
          >
            <i [class]="showOldPassword ? 'pi pi-eye-slash' : 'pi pi-eye'" [attr.aria-hidden]="true"></i>
            <span class="sr-only">{{ showOldPassword ? 'إخفاء كلمة المرور' : 'إظهار كلمة المرور' }}</span>
          </button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">كلمة المرور الجديدة</label>
        <div class="password-input-wrapper">
          <input
            [type]="showNewPassword ? 'text' : 'password'"
            pInputText
            class="w-full password-input"
            required
            [(ngModel)]="changePasswordForm.new_password"
            name="new_password"
            placeholder="أدخل كلمة المرور الجديدة"
            [disabled]="changingPassword"
          />
          <button
            type="button"
            class="password-toggle-btn"
            (click)="toggleNewPasswordVisibility()"
            [disabled]="changingPassword"
            [attr.aria-label]="showNewPassword ? 'إخفاء كلمة المرور' : 'إظهار كلمة المرور'"
            [attr.title]="showNewPassword ? 'إخفاء كلمة المرور' : 'إظهار كلمة المرور'"
          >
            <i [class]="showNewPassword ? 'pi pi-eye-slash' : 'pi pi-eye'" [attr.aria-hidden]="true"></i>
            <span class="sr-only">{{ showNewPassword ? 'إخفاء كلمة المرور' : 'إظهار كلمة المرور' }}</span>
          </button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">تأكيد كلمة المرور الجديدة</label>
        <div class="password-input-wrapper">
          <input
            [type]="showConfirmPassword ? 'text' : 'password'"
            pInputText
            class="w-full password-input"
            required
            [(ngModel)]="changePasswordForm.new_password_confirm"
            name="new_password_confirm"
            placeholder="أعد إدخال كلمة المرور الجديدة"
            [disabled]="changingPassword"
          />
          <button
            type="button"
            class="password-toggle-btn"
            (click)="toggleConfirmPasswordVisibility()"
            [disabled]="changingPassword"
            [attr.aria-label]="showConfirmPassword ? 'إخفاء كلمة المرور' : 'إظهار كلمة المرور'"
            [attr.title]="showConfirmPassword ? 'إخفاء كلمة المرور' : 'إظهار كلمة المرور'"
          >
            <i [class]="showConfirmPassword ? 'pi pi-eye-slash' : 'pi pi-eye'" [attr.aria-hidden]="true"></i>
            <span class="sr-only">{{ showConfirmPassword ? 'إخفاء كلمة المرور' : 'إظهار كلمة المرور' }}</span>
          </button>
        </div>
      </div>

      <div class="dialog-actions">
        <p-button
          type="button"
          label="إلغاء"
          styleClass="p-button-secondary"
          (onClick)="closeChangePasswordDialog()"
          [disabled]="changingPassword"
        ></p-button>
        <p-button
          type="submit"
          [label]="changingPassword ? 'جاري التحديث...' : 'تحديث كلمة المرور'"
          styleClass="p-button-primary"
          [disabled]="changingPassword"
          [loading]="changingPassword"
        ></p-button>
      </div>
    </form>
  </p-dialog>
</header>
